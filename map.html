<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="shortcut icon" href="img/death.gif" type="image/gif" />
<title>Killer Queen - Death Heatmap</title>
</head>
<body>

<p><center>
  <button onclick="setMap('day')"><u>D</u>ay</button>
  <button onclick="setMap('night')"><u>N</u>ight</button>
  <button onclick="setMap('dusk')">D<u>u</u>sk</button>
</center></p>

<div style="width: 960px; margin: auto; position: relative;">
  <img id="map" src="img/map_day.png" width="960" height="540">
  <canvas id="canvas" width="960" height="540"
      style="position: absolute; top: 0; left: 0; opacity: 0.7;"
      ></canvas>
</div>

<script src='simpleheat.js'></script>
<script>
'use strict';
const machineId = Math.round(Math.random() * 9999 + 1);
const players = ['Queen', 'Stripes', 'Abs', 'Skulls', 'Checks'];
const colors = ['Gold', 'Blue'];
const sockDebug = false;


let gMap = null;
let gSock = null;
let gHeat = simpleheat('canvas').max(12).radius(25, 40);
let mapOpac = 0.25;


function mapKill(v) {
  let [x, y, _1, _2] = v.split(',');
  if (y == 11) return;  // Day/dusk snail eat location.
  x = Math.floor(parseFloat(x, 10) / 2);
  y = Math.floor((540 - parseFloat(y, 10) / 2) - 16);
  gHeat.add([x, y, 2]);
}


function changeMapOpac() {
  console.log('drawing heatmap with opacity:', mapOpac);
  localStorage.setItem(`opac_${gMap}`, mapOpac);
  gHeat.draw(mapOpac);
}


function setMap(m) {
  if (m == gMap) return;
  gMap = m;
  document.getElementById('map').setAttribute('src', `img/map_${m}.png`);
  mapOpac = parseFloat(localStorage.getItem(`opac_${gMap}`) || '0.25');

  gHeat.clear();
  let prefix = `kill_${m}_`;
  let j = 0;
  for (let i = 0, k = null; k = localStorage.key(i); i++) {
    if (!k.startsWith(prefix)) continue;
    let v = localStorage.getItem(k);
    mapKill(v);
    j++;
  }
  gHeat.draw(mapOpac);
}


window.addEventListener('keypress', e => {
  switch (e.key) {
    case 'd': setMap('day'); break;
    case 'n': setMap('night'); break;
    case 'u': setMap('dusk'); break;
    case 'ArrowDown':
        mapOpac -= 0.01;
        changeMapOpac();
        break;
    case 'ArrowUp':
        mapOpac += 0.01;
        changeMapOpac();
        break;
  }
}, false);



function sockClose(event) {
  console.log('socket closed!', event);
  gSock.close();
  setTimeout(sockStart, 1500);
}
function sockOpen(event) {
  console.log('socket opened!', event);
  sockSend('connect', {'name': 'null', 'isGameMachine': false});
}
function sockSend(k, v) {
  let vs = JSON.stringify(v);
  let d = `![k[${k}],v[${vs}]]!`;
  if (sockDebug) console.log('>>> WS sending:', d);
  gSock.send(d);
}
function sockStart() {
  console.log('opening socket ...');
  gSock = new WebSocket('ws://localhost:12749');
  gSock.onopen = sockOpen;
  gSock.onclose = sockClose;
  gSock.onmessage = sockMessage;
}


function sockMessage(event) {
  if (sockDebug) console.log('<<< WS received:', event.data);
  let m = event.data.match(/!\[k\[(.*?)\],v\[(.*)?\]\]!/);
  if (!m) {
    console.warn('Could not parse socket message data!\n', event);
    return;
  }
  let [_, k, v] = m;
  switch (k) {
  case 'connected':
    console.log('connected; ', event.data);
    break;
  case 'alive':
    sockSend('im alive', null);
    break;
  case 'playerKill':
    console.log('kill:', v);
    localStorage.setItem(`kill_${gMap}_${new Date().valueOf()}`, v);
    mapKill(v);
    gHeat.draw(mapOpac);
    break;
  case 'playernames':
    console.log('players:', new Date(), v);
    break;
  default:
    console.log('unhandled message: ', k, '=', v);
    break;
  }
};


setMap('day');
sockStart();
</script>
</body>
</html>
