<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Killer Queen - Event Log</title>
<style>
html, body {
  margin: 0;
  padding: 0;
}
#log {
  color: white;
  bottom: 0;
  font-size: 14px;
  left: 0;
  padding: 1ex;
  position: absolute;
  text-shadow: 1px 1px 3px #000;
  width: 100vw;
}
</style>
</head>
<body>

<div id="log"></div>

<script>
'use strict';
const machineId = Math.round(Math.random() * 9999 + 1);
const players = ['Queen', 'Stripes', 'Abs', 'Skulls', 'Checks'];
const colors = ['Gold', 'Blue'];
const sockDebug = false;


let gHost = 'localhost';
let gLog = document.getElementById('log');
let gSock = null;


function sockClose(event) {
  if (sockDebug) console.log('socket closed!', event);
  gSock.close();
  setTimeout(sockStart, 1500);
}
function sockOpen(event) {
  if (sockDebug) console.log('socket opened!', event);
  sockSend('connect', {'name': 'null', 'isGameMachine': false});
}
function sockSend(k, v) {
  let vs = JSON.stringify(v);
  let d = `![k[${k}],v[${vs}]]!`;
  if (sockDebug) console.log('>>> WS sending:', d);
  gSock.send(d);
}
function sockStart() {
  if (sockDebug) console.log('opening socket ...');
  gSock = new WebSocket(`ws://${gHost}:12749`);
  gSock.onopen = sockOpen;
  gSock.onclose = sockClose;
  gSock.onmessage = sockMessage;
}


function sockMessage(event) {
  if (sockDebug) console.log('<<< WS received:', event.data);
  let m = event.data.match(/!\[k\[(.*?)\],v\[(.*)?\]\]!/);
  if (!m) {
    console.warn('Could not parse socket message data!\n', event);
    return;
  }
  let [_, k, v] = m;
  switch (k) {
  case 'connected':
    if (sockDebug) console.log('connected; ', event.data);
    break;
  case 'alive':
    sockSend('im alive', null);
    break;
  default:
    let el = document.createElement('div');
    el.textContent = (new Date()).toLocaleString() + ' ' + event.data;
    localStorage.setItem(`log_${new Date().valueOf()}`, event.data);
    gLog.appendChild(el);
    while (gLog.childNodes.length > 5) {
      gLog.removeChild(gLog.firstChild);
    }
    break;
  }
};


sockStart();
</script>

</body>
</html>
